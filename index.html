<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ultimate Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* CSS (Same as your last "perfect" version with call UI) */
        :root { 
            --bg-color: #f0f2f5; --text-color: #111b21; --primary-color: #00a884; 
            --secondary-color: #ffffff; --input-border-color: #ddd; 
            --message-sent-bg-color: #dcf8c6; --icon-color: #54656f;
        }
        body.dark-theme {
            --bg-color: #0d1418; --text-color: #e9edef; --primary-color: #007a62; 
            --secondary-color: #1f2c33; --input-border-color: #374045; 
            --message-sent-bg-color: #054740; --icon-color: #aebac1; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; }
        
        .input-box { background: var(--secondary-color); color: var(--text-color); border: 2px solid var(--input-border-color); width: 100%; padding: 15px; border-radius: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 1rem; margin-bottom:10px;}
        body.dark-theme .input-box { background: var(--dark-secondary); color: var(--dark-text); border-color: var(--dark-input-border); }
        
        .message { background: var(--secondary-color); color: var(--text-color); padding: 10px 15px; border-radius: 18px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 80%; word-wrap: break-word; }
        body.dark-theme .message { background: var(--dark-secondary); color: var(--dark-text); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .message.sent { background: var(--message-sent-bg-color); margin-left: auto; text-align: right; }
        .message.received { margin-right: auto; text-align: left; }
        .message.system { font-style: italic; color: #666; text-align: center; max-width: 100%; background: transparent; box-shadow: none; font-size: 0.9em; }
        body.dark-theme .message.system { color: #aaa; }

        .chat-header { background: var(--primary-color); padding: 10px 15px; color: white; border-radius: 15px; margin-bottom: 15px; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .action-btn { 
            width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #007a50; 
            border-bottom: 4px solid #006341; border-radius: 15px; 
            background: linear-gradient(145deg, var(--primary-color), #008f72); 
            color: white; cursor: pointer; 
            font-size: 1.1rem; font-weight: bold; text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .action-btn:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        body.dark-theme .action-btn { background: linear-gradient(145deg, var(--primary-color), #00634e); border-color: #005c4b; border-bottom-color: #004b39; }
        
        .app-title { color: var(--primary-color); margin: 2rem 0; font-size: 2.5rem; }
        body.dark-theme .app-title { color: var(--text-color); }
        #copy-id-btn { color: var(--primary-color); position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.5rem; cursor: pointer; display: none; }
        body.dark-theme #copy-id-btn { color: var(--primary-color); }
        
        .chat-input-area { background: var(--secondary-color); border-top: 1px solid var(--input-border-color); padding: 10px; flex-shrink: 0; display: flex; align-items: center; }
        body.dark-theme .chat-input-area { background: var(--dark-secondary); border-top-color: var(--dark-input-border); }
        
        #message-input { background: var(--secondary-color); color: var(--text-color); border: 2px solid var(--input-border-color); flex-grow: 1; padding: 12px 15px; border-radius: 25px; outline: none; font-size: 1rem; margin-right: 10px; }
        body.dark-theme #message-input { background: var(--dark-secondary); color: var(--dark-text); border-color: var(--dark-input-border); }

        #send-chat-btn { background-color: var(--primary-color); color: white; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.5rem; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); flex-shrink: 0; cursor: pointer; }
        body.dark-theme #send-chat-btn { background-color: var(--primary-color); }
        #send-chat-btn:hover { opacity: 0.9; }

        .icon-btn { background: none; border: none; color: var(--icon-color); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .chat-header-actions { display: flex; align-items: center; } 
        .chat-header-actions .icon-btn { color: white; font-size: 1.7rem; margin-left: 8px; }
        body.dark-theme .chat-header-actions .icon-btn { color: var(--text-color); }

        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; padding: 20px; position: relative; }
        #home-page { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .input-container { position: relative; width: 100%; } 
        #peer-id.input-box { padding-right: 45px; } 
        #chat-page { display: none; flex-direction: column; height: 100vh; }
        .chat-header-info { text-align: left; flex-grow: 1; } 
        .chat-header-info h2 { font-size: 1.2rem; margin-bottom: 0px; line-height: 1.3; } 
        .chat-header-info div { font-size: 0.8rem; opacity: 0.9; line-height: 1.2;}
        #contact-mobile-display { font-size: 0.75rem; opacity: 0.7; display: block; margin-top:0px;}

        #messages { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .error-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ff4444; color: white; padding: 12px 20px; border-radius: 25px; display: none; z-index: 2000; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 0.9rem; text-align: center; }
        
        /* Video Call Styles */
        #video-call-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000000; display: none; flex-direction: column; align-items: center; justify-content: space-between; z-index: 1005; padding: 0; }
        #call-ui-header { width: 100%; padding: 10px 15px; background-color: rgba(0,0,0,0.3); color: white; display: flex; justify-content: center; align-items: center; text-align: center; position: absolute; top: 0; left: 0; z-index: 1007; }
        #call-ui-header h2 { font-size: 1.1rem; margin: 0; } #call-ui-header span { font-size: 0.8rem; opacity: 0.8; display: block; }
        .video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: contain; background-color: #000; cursor: pointer; } 
        #local-video { position: absolute; bottom: 85px; right: 15px; width: 25%; max-width: 120px; min-width: 90px; height: auto; aspect-ratio: 3 / 4; border: 1px solid rgba(255,255,255,0.5); z-index: 1006; display: none; border-radius: 4px; background-color: #111; cursor: pointer; } 
        
        #call-controls { display: flex; gap: 15px; padding: 15px; position: absolute; bottom: 0; left: 0; width: 100%; justify-content: center; z-index: 1007; background-color: rgba(0,0,0,0.3); }
        #call-controls button { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; width: 56px; height: 56px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; }
        #call-controls button:hover { background-color: rgba(255,255,255,0.3); }
        #call-controls button.active { background-color: var(--primary-color); }
        #call-controls button.muted svg path, #call-controls button.video-off svg path { fill: #ff5252 !important; } 
        #call-controls button.muted, #call-controls button.video-off { background-color: rgba(100,100,100,0.5); }
        #call-controls button.hang-up { background-color: #E53935; }
        #call-controls button.hang-up:hover { background-color: #C62828; }

        .incoming-call-prompt { background: var(--secondary-color); color: var(--text-color); padding: 15px; border-radius: 10px; margin: 10px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center; max-width: 90%; }
        body.dark-theme .incoming-call-prompt { background: var(--dark-secondary); color: var(--dark-text); }
        .incoming-call-prompt p { margin-bottom: 10px; }
        .incoming-call-prompt button { padding: 8px 15px; margin: 0 5px; border-radius: 5px; border: none; cursor: pointer; }
        .incoming-call-prompt .accept-call { background-color: var(--primary-color); color: white; }
        .incoming-call-prompt .reject-call { background-color: #ccc; color: #333; }
        body.dark-theme .incoming-call-prompt .accept-call { background-color: var(--primary-color); }
        body.dark-theme .incoming-call-prompt .reject-call { background-color: #555; color: var(--text-color); }

        .icon-mic, .icon-mic-off, .icon-video, .icon-video-off, .icon-speaker-on, .icon-speaker-off, .icon-hangup { display: inline-block; width: 24px; height: 24px; }
    </style>
</head>
<body class="light-theme"> 
    <div class="error-msg">‚ö†Ô∏è Error Message Placeholder</div>

    <div id="home-page" class="container">
        <h1 class="app-title">üí¨ Ultimate Chat</h1>
        <input type="text" id="friend-name" placeholder="Friend's Name (Required) ‚úçÔ∏è" class="input-box">
        <input type="tel" id="friend-mobile" placeholder="Friend's Mobile (Optional) üì±" class="input-box">
        <div class="input-container">
            <input type="text" id="peer-id" placeholder="Your ID / Friend's ID üîë" class="input-box">
            <button id="copy-id-btn" title="Copy ID">üìã</button>
        </div>
        <button class="action-btn" onclick="window.createNewChat()">üÜî Create My ID</button>
        <button class="action-btn" onclick="window.startChat()">üöÄ Connect to Friend</button>
    </div>

    <div id="chat-page" class="container">
        <div class="chat-header">
            <div class="chat-header-info">
                <h2 id="chat-page-contact-name-display">Friend</h2>
                <span id="contact-mobile-display"></span>
                <div id="connection-status">üîí P2P Encrypted</div>
            </div>
            <div class="chat-header-actions">
                <button id="audio-call-btn" class="icon-btn" title="Audio Call">üìû</button>
                <button id="video-call-btn" class="icon-btn" title="Video Call">üìπ</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-chat-btn" title="Send">üì§</button>
        </div>
    </div>

    <div id="video-call-container">
        <div id="call-ui-header">
            <div><h2 id="call-contact-name-overlay">Calling...</h2><span id="call-status-overlay">Connecting...</span></div>
        </div>
        <div class="video-wrapper">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div id="call-controls">
            <button id="toggle-mic-btn" class="icon-btn" title="Mute Mic"></button>
            <button id="toggle-video-btn" class="icon-btn" title="Turn Video Off"></button>
            <button id="toggle-speaker-btn" class="icon-btn" title="Earpiece"></button>
            <button id="hang-up-btn" class="icon-btn hang-up"></button>
        </div>
    </div>
    <audio id="ringing-tone" src="https://cdn.freesound.org/previews/270/270306_5121236-lq.mp3" loop></audio>

    <script>
        // ----- SVG Icons (DEFINED ONLY ONCE AT THE TOP) -----
        const icons = {
            micOn: `<svg class="icon-mic" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg>`,
            micOff: `<svg class="icon-mic-off" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.09.43L13.14 10H12v.11l1.77 1.77c.04-.1.04-.21.04-.31v-1.15c0-.55-.45-1-1-1s-1 .45-1 1v.02l-2.48-2.48C9.69 7.2 9.97 7 10.28 7c.89 0 1.64.55 1.93 1.3l1.43-1.43C13.03 5.96 12.07 5.48 11 5.48c-1.66 0-3 1.34-3 3v1.41l-1.98-1.98L4.61 9.34 3.2 7.93 2.07 9.34l3.56 3.56L3.07 15.46l1.41 1.41L6.34 15H8v1.41l-3.97 3.97 1.41 1.41L21.93 4.07l-1.41-1.41L14.91 11.43zM9 11.92V12c0 1.66 1.34 3 3 3 .74 0 1.4-.27 1.93-.7L9.17 9.54C9.06 10.09 9 10.66 9 11.18v.74z"></path></svg>`,
            videoOn: `<svg class="icon-video" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></svg>`,
            videoOff: `<svg class="icon-video-off" viewBox="0 0 24 24" fill="currentColor"><path d="M20.99 4.02L4.02 20.99l1.41 1.41L22.41 5.43 20.99 4.02zM17 16.5V18c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V7c0-.35.18-.66.46-.83l-1.01-1.01C2.17 5.45 2 5.92 2 6.41v11.18c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-2.18l.55-.55L17 16.5zm0-6V7c0-.55-.45-1-1-1H7.82l2 2H16v1.18l1 .99V10.5zm3 6.5V7.5l-4-4v2.18l6.61 6.61c.24-.17.39-.44.39-.74zM3 6.83V7c0-.35.18-.66.46-.83L3 5.76V6.83z"></path></svg>`,
            speakerOn: `<svg class="icon-speaker-on" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`,
            speakerOff: `<svg class="icon-speaker-off" viewBox="0 0 24 24" fill="currentColor"><path d="M7 9v6h4l5 5V4L7 9H3zm7-.12L11.88 11H10V9h.39L7.88 6.48 7 7.36V9H5V7h2.3L3.41 3.11 4.82 1.7 16.5 13.38l-1.62 1.62L14 14.12V19l-3.12-3.12L9.83 17H11v-2.12L7.76 11.64 7 12.4V15h2v1.61l-3.89 3.89 1.41 1.41L19.1 4.83 17.69 3.41 14 7.1zm7.5 4.38c0 1.77-1.02 3.29-2.5 4.03v-1.75l1.49-1.49c.01.06.01.12.01.18zm0-5.03c.01-.06.01-.12.01-.18L19 7.83v-.06c-4.01-.91-7-4.49-7-8.77h-2c0 4.28 2.99 7.86 7 8.77z"></path></svg>`,
            hangup: `<svg class="icon-hangup" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></svg>`
        };

        // ----- Global Variables ----- 
        let peer; let conn; let myPeerId = null; let connectToFriendIdAfterInitialize = null; 
        let localStream = null; let currentCall = null; let incomingCallInstance = null;
        let isSpeakerphoneOn = false; let isMicMuted = false; let isVideoOff = false;
        let callTimeoutId = null; 
        const CALL_RING_TIMEOUT = 20000; 

        // ----- DOM Elements (Defined After DOMContentLoaded) ----- 
        let errorMsgEl, copyIdBtn, peerIdInput, friendNameInput, friendMobileInput, 
            chatPageContactNameDisplay, contactMobileDisplay, messagesDiv, messageInput, 
            homePageEl, chatPageEl, audioCallBtn, videoCallBtn, sendChatBtn, 
            connectionStatusEl, videoCallContainer, localVideoEl, remoteVideoEl, 
            toggleMicBtn, toggleVideoBtn, toggleSpeakerBtn, hangUpBtn, 
            callContactNameOverlayEl, callStatusOverlayEl, ringingToneAudio;

        function initializeDOMElements() {
            console.log("DOM_ELEMENTS: Attempting to initialize...");
            errorMsgEl = document.querySelector('.error-msg'); 
            copyIdBtn = document.getElementById('copy-id-btn'); 
            peerIdInput = document.getElementById('peer-id'); 
            friendNameInput = document.getElementById('friend-name'); 
            friendMobileInput = document.getElementById('friend-mobile'); 
            chatPageContactNameDisplay = document.getElementById('chat-page-contact-name-display');
            contactMobileDisplay = document.getElementById('contact-mobile-display'); 
            messagesDiv = document.getElementById('messages'); 
            messageInput = document.getElementById('message-input'); 
            homePageEl = document.getElementById('home-page'); 
            chatPageEl = document.getElementById('chat-page'); 
            audioCallBtn = document.getElementById('audio-call-btn'); 
            videoCallBtn = document.getElementById('video-call-btn'); 
            sendChatBtn = document.getElementById('send-chat-btn');
            connectionStatusEl = document.getElementById('connection-status');
            videoCallContainer = document.getElementById('video-call-container');
            localVideoEl = document.getElementById('local-video');
            remoteVideoEl = document.getElementById('remote-video');
            toggleMicBtn = document.getElementById('toggle-mic-btn');
            toggleVideoBtn = document.getElementById('toggle-video-btn');
            toggleSpeakerBtn = document.getElementById('toggle-speaker-btn');
            hangUpBtn = document.getElementById('hang-up-btn');
            callContactNameOverlayEl = document.getElementById('call-contact-name-overlay'); 
            callStatusOverlayEl = document.getElementById('call-status-overlay'); 
            ringingToneAudio = document.getElementById('ringing-tone');
            console.log("DOM_ELEMENTS: Initialization complete.");
        }

        // ----- Event Listeners Setup ----- 
        function setupEventListeners() {
            console.log("SETUP_LISTENERS: Attaching event listeners...");
            try {
                if (copyIdBtn) copyIdBtn.addEventListener('click', () => { if (peerIdInput && peerIdInput.value) { navigator.clipboard.writeText(peerIdInput.value).then(() => showError('‚úÖ ID Copied!')).catch(err => { console.error('Copy failed: ', err); showError('‚ùå Copy failed.'); }); } else { showError('ü§î No ID to copy.'); }});
                else console.warn("SETUP_LISTENERS_WARN: copyIdBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to copyIdBtn:", e); }

            try {
                if (messageInput) messageInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
                else console.warn("SETUP_LISTENERS_WARN: messageInput not found for listener");
            } catch (e) { console.error("Error attaching listener to messageInput:", e); }
            
            try {
                if (sendChatBtn) sendChatBtn.addEventListener('click', sendMessage);
                else console.warn("SETUP_LISTENERS_WARN: sendChatBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to sendChatBtn:", e); }

            try {
                if (audioCallBtn) audioCallBtn.addEventListener('click', () => startCallAttempt('audio'));
                else console.warn("SETUP_LISTENERS_WARN: audioCallBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to audioCallBtn:", e); }

            try {
                if (videoCallBtn) videoCallBtn.addEventListener('click', () => startCallAttempt('video'));
                else console.warn("SETUP_LISTENERS_WARN: videoCallBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to videoCallBtn:", e); }

            try {
                if (hangUpBtn) hangUpBtn.addEventListener('click', endCall);
                else console.warn("SETUP_LISTENERS_WARN: hangUpBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to hangUpBtn:", e); }
            
            try {
                if (toggleMicBtn) toggleMicBtn.addEventListener('click', toggleMicrophone);
                else console.warn("SETUP_LISTENERS_WARN: toggleMicBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to toggleMicBtn:", e); }

            try {
                if (toggleVideoBtn) toggleVideoBtn.addEventListener('click', toggleCamera);
                else console.warn("SETUP_LISTENERS_WARN: toggleVideoBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to toggleVideoBtn:", e); }

            try {
                if (toggleSpeakerBtn) toggleSpeakerBtn.addEventListener('click', toggleSpeaker);
                else console.warn("SETUP_LISTENERS_WARN: toggleSpeakerBtn not found for listener");
            } catch (e) { console.error("Error attaching listener to toggleSpeakerBtn:", e); }
            
            try {
                if(localVideoEl) localVideoEl.addEventListener('click', swapVideoFeeds);
                else console.warn("SETUP_LISTENERS_WARN: localVideoEl not found for listener");
            } catch (e) { console.error("Error attaching listener to localVideoEl:", e); }
            
            try {
                if(remoteVideoEl) remoteVideoEl.addEventListener('click', swapVideoFeeds);
                else console.warn("SETUP_LISTENERS_WARN: remoteVideoEl not found for listener");
            } catch (e) { console.error("Error attaching listener to remoteVideoEl:", e); }
            
            console.log("SETUP_LISTENERS: Event listeners attachment attempt complete.");
        }

        // ----- Theme Logic (Simplified) ----- 
        function applySavedTheme() { 
            if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-theme');} 
            else { document.body.classList.remove('dark-theme');}
        }

        // ----- UI Helper Functions ----- 
        function showError(text, duration = 4000) { 
            console.log(`SHOW_ERROR: ${text}`); 
            if(errorMsgEl) { 
                errorMsgEl.textContent = text; errorMsgEl.style.display = 'block'; 
                setTimeout(() => { if(errorMsgEl) errorMsgEl.style.display = 'none'; }, duration); 
            } else { 
                console.error("SHOW_ERROR_FAIL: errorMsgEl not found. Alerting instead."); 
                alert(text); 
            }
        }
        
        // ----- Functions called by HTML onclick MUST be global -----
        window.createNewChat = function() { 
            console.log("UI_ACTION: Create New Chat clicked."); 
            connectToFriendIdAfterInitialize = null; 
            if(peerIdInput) peerIdInput.value = ''; 
            initializePeer(); 
        }
        window.startChat = function() { 
            const friendName = friendNameInput ? friendNameInput.value.trim() : "";
            const friendMobile = friendMobileInput ? friendMobileInput.value.trim() : "";
            const remotePeerId = peerIdInput ? peerIdInput.value.trim() : null; 

            console.log(`UI_ACTION: Start Chat to: ${remotePeerId} with name: ${friendName}`); 
            if (!friendName) { showError("‚ùó Friend's Name is required."); if(friendNameInput) friendNameInput.focus(); return; }
            if (!remotePeerId) { showError('üîó Enter Friend\'s ID.'); return; } 
            if (conn && conn.open && conn.peer === remotePeerId) { showError("üí¨ Already connected."); switchToChatPage(); return; } 
            if (conn && conn.open) { showError("üí¨ Connected to someone else. Disconnect first."); return; } 
            if (remotePeerId === myPeerId) { showError('ü§î This is your ID.'); return; } 
            if (!peer || !peer.id) { 
                showError("‚è≥ Initializing client. Please wait a moment and try again.", 5000); 
                connectToFriendIdAfterInitialize = remotePeerId; 
                if (!peer) initializePeer(); 
                return; 
            } 
            if (peer.open) { attemptActualConnection(remotePeerId, friendName, friendMobile); } 
            else { showError("‚è≥ Client preparing. Please wait a moment and try again.", 5000); connectToFriendIdAfterInitialize = remotePeerId;}
        }
        
        // ----- Core PeerJS Logic (initializePeer, attemptActualConnection, etc.) -----
        // (Pasted from your previous complete code version with fixes)
        function initializePeer() { console.log("PEER_INIT: Initializing Peer..."); if (peer) { console.log("PEER_INIT: Destroying existing peer instance."); peer.destroy(); } peer = new Peer(undefined, { host: '0.peerjs.com', port: 443, secure: true, debug: 1, config: {iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]} });  peer.on('open', id => { console.log('PEER_OPEN: My peer ID is: ' + id); myPeerId = id; if(peerIdInput) peerIdInput.value = id; if(copyIdBtn) copyIdBtn.style.display = 'inline-block'; if (connectToFriendIdAfterInitialize) { const fn = friendNameInput ? friendNameInput.value.trim() : "Friend"; const fm = friendMobileInput ? friendMobileInput.value.trim() : ""; showError(`‚úÖ Client ready. Connecting to ${connectToFriendIdAfterInitialize}...`); attemptActualConnection(connectToFriendIdAfterInitialize, fn, fm); connectToFriendIdAfterInitialize = null; } else { showError(`üéâ Your ID: ${myPeerId}. Share it!`); }});  peer.on('connection', incomingConn => { console.log("PEER_CONN_INCOMING: From:", incomingConn.peer); if (conn && conn.open) { console.log("PEER_CONN_INCOMING: Busy. Rejecting from " + incomingConn.peer); incomingConn.close(); return; } conn = incomingConn; let fName = (conn.metadata && conn.metadata.name) || `Friend (${conn.peer.slice(-6)})`; let fMobile = (conn.metadata && conn.metadata.mobile) || ""; setupDataConnectionEvents(conn, fName, fMobile);});  peer.on('call', incomingMediaCall => { console.log("PEER_MEDIA_CALL_INCOMING: From", incomingMediaCall.peer); if (currentCall || incomingCallInstance) { console.warn("PEER_MEDIA_CALL_INCOMING: Busy. Rejecting from", incomingMediaCall.peer); incomingMediaCall.close(); return; } incomingCallInstance = incomingMediaCall; const callType = (incomingMediaCall.metadata && incomingMediaCall.metadata.callType) || "audio"; const caller = (incomingMediaCall.metadata && incomingMediaCall.metadata.callerName) || incomingMediaCall.peer; showIncomingCallPrompt(caller, callType); }); peer.on('disconnected', () => { console.warn("PEER_DISCONNECTED."); showError("‚ÄºÔ∏è Disconnected from PeerJS server."); endCallCleanup(); });  peer.on('close', () => { console.warn("PEER_CLOSE."); showError("üõë Peer instance closed.", 6000); myPeerId = null; if (peerIdInput && peerIdInput.value === (peer && peer.id)) peerIdInput.value = ''; if(copyIdBtn) copyIdBtn.style.display = 'none'; endCallCleanup(); });  peer.on('error', err => { console.error('PEER_ERROR:', err); let msg = `‚ö†Ô∏è PeerJS Error: ${err.type}`; showError(msg, 7000); endCallCleanup(); });  }
        function attemptActualConnection(targetPeerId, friendNameForDisplay, friendMobileForDisplay) { console.log(`CONN_ATTEMPT: To ${targetPeerId} (Display Name: ${friendNameForDisplay}, Mobile: ${friendMobileForDisplay})`); if (!peer || !peer.open) { console.warn("CONN_ATTEMPT: Peer not open."); showError("‚è≥ Client not ready.", 5000); connectToFriendIdAfterInitialize = targetPeerId; if (!peer) initializePeer(); return; } const myProfileName = document.getElementById('friend-name') ? (document.getElementById('friend-name').value.trim() || "A Friend") : "A Friend"; const myProfileMobile = document.getElementById('friend-mobile') ? document.getElementById('friend-mobile').value.trim() : ""; if (conn && conn.open && conn.peer !== targetPeerId) { console.log(`CONN_ATTEMPT: Closing existing DataConn with ${conn.peer}`); conn.close(); } conn = peer.connect(targetPeerId, { metadata: { name: myProfileName, mobile: myProfileMobile }, reliable: true, serialization: 'binary' }); console.log(`CONN_ATTEMPT: DataConn object created for ${targetPeerId}.`); setupDataConnectionEvents(conn, friendNameForDisplay, friendMobileForDisplay); }
        function setupDataConnectionEvents(dataConnection, contactDisplayName, contactDisplayMobile) { console.log(`SETUP_DATA_CONN_EVENTS: For ${dataConnection.peer}. Displaying Name: ${contactDisplayName}, Mobile: ${contactDisplayMobile}`); dataConnection.removeAllListeners(); dataConnection.on('open', () => { console.log(`DATA_CONN_OPEN: With ${dataConnection.peer}. Metadata from them:`, dataConnection.metadata); const peerActualName = (dataConnection.metadata && dataConnection.metadata.name) || contactDisplayName; const peerActualMobile = (dataConnection.metadata && dataConnection.metadata.mobile) || contactDisplayMobile; if(chatPageContactNameDisplay) chatPageContactNameDisplay.textContent = peerActualName; if(contactMobileDisplay) { contactMobileDisplay.textContent = peerActualMobile || ""; contactMobileDisplay.style.display = peerActualMobile ? 'block' : 'none'; } if(messagesDiv) messagesDiv.innerHTML = ''; switchToChatPage(); showError(`‚úÖ Connected to ${peerActualName}!`, 5000); }); dataConnection.on('data', data => { let logData = data; if (typeof data === 'string' && data.length > 100) logData = `String (len:${data.length}), first: ${data.substring(0,100)}`; console.log(`DATA_RECV: From ${dataConnection.peer}: Type: ${typeof data}`, logData); if (typeof data === 'string') { try { const decoded = decodeURIComponent(escape(atob(data))); appendMessage(decoded, false, chatPageContactNameDisplay ? chatPageContactNameDisplay.textContent : "Friend"); } catch (e) { appendMessage(String(data), false, chatPageContactNameDisplay ? chatPageContactNameDisplay.textContent : "Friend"); } } else { console.warn("DATA_RECV: Non-string data on DataConn:", data); } }); dataConnection.on('close', () => {  console.warn(`DATA_CONN_CLOSE: With ${dataConnection.peer}.`); showError(`üíî ${(chatPageContactNameDisplay ? chatPageContactNameDisplay.textContent : "Friend")} disconnected.`); endCallCleanup(); }); dataConnection.on('error', err => { console.error(`DATA_CONN_ERROR: With ${dataConnection.peer}:`, err); showError(`‚ö†Ô∏è Data conn error: ${err.type}`); endCallCleanup(); }); }
        function switchToChatPage() { console.log("SWITCH_TO_CHAT_PAGE: Called."); if (homePageEl && chatPageEl) { homePageEl.style.display = 'none'; chatPageEl.style.display = 'flex'; if(messageInput) messageInput.focus(); console.log("SWITCH_TO_CHAT_PAGE: Switched."); } else { console.error("SWITCH_TO_CHAT_PAGE: Elements NULL!"); }}
        function appendMessage(text, isSender, senderDisplayName = "Friend") { const el = document.createElement('div'); el.classList.add('message'); let fullText; if (senderDisplayName==="System") { el.classList.add('system'); fullText=text; } else if (isSender) { el.classList.add('sent'); fullText=`You: ${text}`; } else { el.classList.add('received'); fullText=`${senderDisplayName||"Friend"}: ${text}`; } el.textContent=fullText; if(messagesDiv) {messagesDiv.appendChild(el); messagesDiv.scrollTop=messagesDiv.scrollHeight;} else { console.error("APPEND_MESSAGE_FAIL: messagesDiv not found.");} }
        function sendMessage() { const text = messageInput ? messageInput.value.trim() : ""; if (!conn || !conn.open) { showError('‚ö†Ô∏è Not connected.'); return; } if (text) { try { const encoded = btoa(unescape(encodeURIComponent(text))); conn.send(encoded); appendMessage(text, true); if(messageInput) {messageInput.value=''; messageInput.focus();} } catch (e) { console.error("SEND_MSG_ERROR:", e); showError("‚ùå Error sending."); } } }
        async function getLocalMedia(constraints) { console.log("MEDIA_ACCESS: Requesting with constraints:", constraints); if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; console.log("MEDIA_ACCESS: Stopped existing local stream."); } try { const stream = await navigator.mediaDevices.getUserMedia(constraints); localStream = stream; if (localVideoEl) { localVideoEl.srcObject = stream; localVideoEl.play().catch(e=>console.warn("Local video play error:", e)); localVideoEl.style.display = (constraints.video && !isVideoOff) ? 'block' : 'none'; } console.log("MEDIA_ACCESS: Local stream obtained. Video enabled:", !!constraints.video); isMicMuted = !constraints.audio; isVideoOff = !constraints.video; updateCallControlIcons(); return stream; } catch (err) { console.error("MEDIA_ACCESS_ERROR:", err); showError(`‚ùå Media Error: ${err.name}. Check permissions.`, 6000); endCallCleanup(); return null; } }
        async function startCallAttempt(callType) { if (!conn || !conn.open || !conn.peer) { showError("‚ö†Ô∏è Not connected to friend for call."); return; } if (currentCall) { showError("‚ö†Ô∏è Already in a call."); return; } console.log(`CALL_INITIATE: Attempting ${callType} call with ${conn.peer}`); const constraints = callType === 'video' ? { video: true, audio: true } : { audio: true, video: false }; isMicMuted = false; isVideoOff = !constraints.video; const stream = await getLocalMedia(constraints); if (!stream) { showError(`‚ùå Could not start ${callType} call: Media access failed.`); return; } const friendChatName = (chatPageContactNameDisplay ? chatPageContactNameDisplay.textContent : null) || conn.peer; showCallUI(callType, `Calling ${friendChatName}...`); const myProfileName = (friendNameInput ? friendNameInput.value.trim() : null) || myPeerId; const call = peer.call(conn.peer, stream, { metadata: { callType: callType, callerName: myProfileName } }); if (call) { currentCall = call; setupMediaCallEvents(currentCall, friendChatName); console.log(`CALL_INITIATE: MediaCall object created for ${callType} call to ${currentCall.peer}.`); playRingingTone(); callTimeoutId = setTimeout(() => { if (currentCall && !currentCall.open) { console.log("CALL_TIMEOUT: Call not answered. Ending."); showError("Call not answered.", 5000); endCall(); }}, CALL_RING_TIMEOUT); } else { console.error("CALL_INITIATE_ERROR: peer.call() failed."); showError("‚ùå Error initiating call.", 6000); endCallCleanup(); } }
        function showIncomingCallPrompt(callerNameToShow, callType) { stopRingingTone(); const existingPrompt = document.getElementById('incoming-call-prompt-el'); if (existingPrompt) existingPrompt.remove(); const promptDiv = document.createElement('div'); promptDiv.id = 'incoming-call-prompt-el'; promptDiv.className = 'incoming-call-prompt message system'; promptDiv.innerHTML = `<p>üìû Incoming ${callType} call from ${callerNameToShow}!</p> <button class="accept-call">Accept</button> <button class="reject-call">Reject</button>`; if(messagesDiv) {messagesDiv.appendChild(promptDiv); messagesDiv.scrollTop = messagesDiv.scrollHeight;} promptDiv.querySelector('.accept-call').onclick = async () => { promptDiv.remove(); if (!incomingCallInstance) { console.error("INCOMING_CALL_ERROR: No instance to accept."); return; } console.log("INCOMING_CALL_ACCEPT: User accepted from", incomingCallInstance.peer); currentCall = incomingCallInstance; incomingCallInstance = null; const remoteMetaCallType = (currentCall.metadata && currentCall.metadata.callType) || 'audio'; const constraints = (remoteMetaCallType === 'video') ? { video: true, audio: true } : { audio: true, video: false }; isMicMuted = false; isVideoOff = !constraints.video; const stream = await getLocalMedia(constraints); if (!stream) { showError("‚ùå Could not accept call: Media failed."); currentCall.close(); currentCall = null; return; } showCallUI(remoteMetaCallType, `In call with ${callerNameToShow}`); currentCall.answer(stream); setupMediaCallEvents(currentCall, callerNameToShow); }; promptDiv.querySelector('.reject-call').onclick = () => { promptDiv.remove(); if (incomingCallInstance) { console.log("INCOMING_CALL_REJECT: User rejected from", incomingCallInstance.peer); incomingCallInstance.close(); incomingCallInstance = null; }}; }
        function setupMediaCallEvents(mediaCall, friendNameForDisplay) { console.log("SETUP_MEDIA_CALL_EVENTS: For call with", mediaCall.peer); mediaCall.removeAllListeners(); clearTimeout(callTimeoutId); stopRingingTone(); mediaCall.on('stream', remoteStream => { console.log("MEDIA_CALL_STREAM: Received remote stream from", mediaCall.peer, remoteStream); if (remoteVideoEl) { remoteVideoEl.srcObject = remoteStream; remoteVideoEl.play().catch(e => console.error("Remote video play error:", e)); remoteVideoEl.style.display = 'block'; } if (localVideoEl && localStream) { localVideoEl.srcObject = localStream; localVideoEl.play().catch(e=>console.warn("Local video play after remote stream error:", e)); const callType = (mediaCall.metadata && mediaCall.metadata.callType) || 'audio'; if (callType === 'video') { localVideoEl.style.display = isVideoOff ? 'none' : 'block'; } else { localVideoEl.style.display = 'none'; } } if (callContactNameOverlayEl) callContactNameOverlayEl.textContent = friendNameForDisplay || mediaCall.peer; if (callStatusOverlayEl) callStatusOverlayEl.textContent = "Connected"; if (videoCallContainer && videoCallContainer.style.display !== 'flex') { showCallUI((mediaCall.metadata && mediaCall.metadata.callType) || 'audio', `In call with ${friendNameForDisplay || mediaCall.peer}`); } }); mediaCall.on('close', () => { console.log("MEDIA_CALL_CLOSE: Event from", mediaCall.peer); showError(`Call with ${friendNameForDisplay || mediaCall.peer} ended.`); endCallCleanup(); }); mediaCall.on('error', err => { console.error("MEDIA_CALL_ERROR: Event from", mediaCall.peer, err); showError(`‚ö†Ô∏è Call error: ${err.message || err.type || 'Unknown error'}`); endCallCleanup(); }); }
        function showCallUI(callType, statusText = "Connecting...") { console.log("UI_UPDATE: Showing call UI for type:", callType, "Status:", statusText); const nameToDisplay = (chatPageContactNameDisplay ? chatPageContactNameDisplay.textContent : null) || "Friend"; if (callContactNameOverlayEl) callContactNameOverlayEl.textContent = nameToDisplay; if (callStatusOverlayEl) callStatusOverlayEl.textContent = statusText; if (videoCallContainer) videoCallContainer.style.display = 'flex'; if (messagesDiv) messagesDiv.style.display = 'none'; const chatInputArea = document.querySelector('.chat-input-area'); if (chatInputArea) chatInputArea.style.display = 'none'; if (toggleVideoBtn) toggleVideoBtn.style.display = (callType === 'video') ? 'flex' : 'none'; if (localStream && localVideoEl) { localVideoEl.srcObject = localStream; localVideoEl.play().catch(e=>console.warn("Local video play in showCallUI failed",e)); if (callType === 'video') { localVideoEl.style.display = isVideoOff ? 'none' : 'block'; } else { localVideoEl.style.display = 'none'; } } else if (localVideoEl) { localVideoEl.style.display = 'none'; } if (remoteVideoEl && !remoteVideoEl.srcObject) { remoteVideoEl.style.backgroundColor = '#000'; } updateCallControlIcons(); }
        function hideCallUI() { console.log("UI_UPDATE: Hiding call UI."); if (videoCallContainer) videoCallContainer.style.display = 'none'; if (messagesDiv) messagesDiv.style.display = 'block'; const chatInputArea = document.querySelector('.chat-input-area'); if (chatInputArea) chatInputArea.style.display = 'flex'; if (connectionStatusEl) connectionStatusEl.textContent = "üîí P2P Encrypted"; }
        function endCall() { console.log("END_CALL: User initiated hang up."); clearTimeout(callTimeoutId); stopRingingTone(); if (currentCall) { console.log("END_CALL: Closing currentCall object for peer:", currentCall.peer); currentCall.close(); } else if (incomingCallInstance) { console.log("END_CALL: Closing incomingCallInstance."); incomingCallInstance.close(); const prompt = document.getElementById('incoming-call-prompt-el'); if (prompt) prompt.remove(); } else { console.log("END_CALL: No active call object, just cleaning up UI."); endCallCleanup(); }} // Removed redundant endCallCleanup here as .close() should trigger it.
        function endCallCleanup() { console.log("END_CALL_CLEANUP: Cleaning up."); clearTimeout(callTimeoutId); stopRingingTone(); if (localStream) { localStream.getTracks().forEach(track => track.stop()); console.log("END_CALL_CLEANUP: Local stream tracks stopped."); } localStream = null; if(localVideoEl) { localVideoEl.srcObject = null; localVideoEl.style.display = 'none';} if(remoteVideoEl) { remoteVideoEl.srcObject = null; remoteVideoEl.style.display = 'none';} if (currentCall && currentCall.close && typeof currentCall.close === 'function' && (!currentCall.open === false ) ) { /* No need to close again if already closed by event */ } currentCall = null; incomingCallInstance = null; hideCallUI(); const existingPrompt = document.getElementById('incoming-call-prompt-el'); if (existingPrompt) existingPrompt.remove(); isMicMuted = false; isVideoOff = false; isSpeakerphoneOn = false; updateCallControlIcons(); }
        function updateCallControlIcons() { if(toggleMicBtn) { toggleMicBtn.innerHTML = isMicMuted ? icons.micOff : icons.micOn; toggleMicBtn.classList.toggle('muted', isMicMuted); } if(toggleVideoBtn) { toggleVideoBtn.innerHTML = isVideoOff ? icons.videoOff : icons.videoOn; toggleVideoBtn.classList.toggle('video-off', isVideoOff); } if(toggleSpeakerBtn) { toggleSpeakerBtn.innerHTML = isSpeakerphoneOn ? icons.speakerOff : icons.speakerOn; } if(hangUpBtn) { hangUpBtn.innerHTML = icons.hangup; }}
        function toggleMicrophone() { if (!localStream || localStream.getAudioTracks().length === 0) { console.warn("TOGGLE_MIC: No local audio track."); return; } const audioTrack = localStream.getAudioTracks()[0]; audioTrack.enabled = !audioTrack.enabled; isMicMuted = !audioTrack.enabled; updateCallControlIcons(); console.log("TOGGLE_MIC:", audioTrack.enabled ? "Unmuted" : "Muted"); }
        function toggleCamera() { if (!localStream || localStream.getVideoTracks().length === 0) { console.warn("TOGGLE_VIDEO: No local video track."); if(toggleVideoBtn) toggleVideoBtn.style.display = 'none'; return; } const videoTrack = localStream.getVideoTracks()[0]; videoTrack.enabled = !videoTrack.enabled; isVideoOff = !videoTrack.enabled; updateCallControlIcons(); if (localVideoEl) localVideoEl.style.display = videoTrack.enabled ? 'block' : 'none'; console.log("TOGGLE_VIDEO:", videoTrack.enabled ? "Video On" : "Video Off"); }
        async function toggleSpeaker() { if (!remoteVideoEl || !remoteVideoEl.srcObject) { showError("üîä No active call stream."); return; } if (typeof remoteVideoEl.setSinkId !== 'function') { showError("üîä Speaker toggle not supported.", 4000); return; } try { const devices = await navigator.mediaDevices.enumerateDevices(); const audioOutputDevices = devices.filter(d => d.kind === 'audiooutput'); console.log("AUDIO_OUTPUT_DEVICES:", audioOutputDevices.map(d=>({id:d.deviceId, label:d.label}))); let targetDeviceId = 'default'; if (!isSpeakerphoneOn) { const speaker = audioOutputDevices.find(d => d.label.toLowerCase().includes('speaker')) || audioOutputDevices.find(d => d.deviceId !== 'default' && d.deviceId !== ''); if (speaker) targetDeviceId = speaker.deviceId; else if (audioOutputDevices.length > 1) { targetDeviceId = audioOutputDevices[1].deviceId; console.warn("SPEAKER_TOGGLE: No explicit speaker, using fallback.");} else { console.warn("SPEAKER_TOGGLE: Only one audio output."); showError("üîä Could not find speaker device."); return;} isSpeakerphoneOn = true; } else { isSpeakerphoneOn = false; } console.log(`SPEAKER_TOGGLE: Setting sinkId to: ${targetDeviceId}. Speaker on: ${isSpeakerphoneOn}`); await remoteVideoEl.setSinkId(targetDeviceId); updateCallControlIcons(); showError(`üîä Switched to ${isSpeakerphoneOn ? 'Loudspeaker' : 'Earpiece'}.`, 2000); } catch (err) { console.error("SPEAKER_TOGGLE_ERROR:", err); showError("‚ùå Error toggling speaker.", 4000); isSpeakerphoneOn = !isSpeakerphoneOn; updateCallControlIcons(); }}
        function playRingingTone() { if (ringingToneAudio) { ringingToneAudio.currentTime = 0; ringingToneAudio.play().catch(e => console.warn("Ringing tone play failed:", e)); console.log("AUDIO: Ringing tone started."); }}
        function stopRingingTone() { if (ringingToneAudio) { ringingToneAudio.pause(); ringingToneAudio.currentTime = 0; console.log("AUDIO: Ringing tone stopped."); }}
        function swapVideoFeeds() { if (!localVideoEl || !remoteVideoEl || !localStream || !currentCall || !currentCall.remoteStream) { console.warn("SWAP_VIDEO: Cannot swap, streams/call missing."); return; } console.log("SWAP_VIDEO: Swapping video feeds."); const remoteVideoIsShowingLocal = (remoteVideoEl.srcObject === localStream); if (remoteVideoIsShowingLocal) { remoteVideoEl.srcObject = currentCall.remoteStream; localVideoEl.srcObject = localStream; remoteVideoEl.muted = false; localVideoEl.muted = true; console.log("SWAP_VIDEO: Switched to Remote on big."); } else { remoteVideoEl.srcObject = localStream; localVideoEl.srcObject = currentCall.remoteStream; remoteVideoEl.muted = true; localVideoEl.muted = false; console.log("SWAP_VIDEO: Switched to Local on big."); } remoteVideoEl.play().catch(e=>console.warn("Remote video play after swap failed", e)); localVideoEl.play().catch(e=>console.warn("Local video play after swap failed", e));}

        // ----- Initial UI Setup ----- 
        function initialUISetup() { 
            console.log("UI_INIT: Starting initial setup.");
            initializeDOMElements(); 
            if(peerIdInput) peerIdInput.value = ''; 
            if(copyIdBtn) copyIdBtn.style.display = 'none'; 
            applySavedTheme(); 
            setupEventListeners(); 
            updateCallControlIcons(); 
            console.log("UI_INIT: Initial setup complete. Event listeners attached.");
        }
        document.addEventListener('DOMContentLoaded', initialUISetup);
    </script>
</body>
</html>
